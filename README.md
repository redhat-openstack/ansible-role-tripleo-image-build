Role Name
=========

ansible-role-tripleo-image-build

Requirements
------------

This role requires libguestfs, virt-customize, virt-sparsify, and other dependencies via parts/kvm and parts/libvirt.

How does it work?
-----------------

tasks/main.yml After nuking the working directory:
* (repo_setup.yml)         Get the base image and setup yum repositories
* (package_install.yml)    Install packages for overcloud base image
* (convert_undercloud.yml) Use overcloud base image to create undercloud base image
* (dib_build.yml)          Use DIB to build the overlcloud-full and IPA images
* (undercloud_inject.yml)  Inject overcloud-full and IPA images into the undercloud image

Notes:
* The overcloud image is constructed by a series of calls to [virt-customize](http://libguestfs.org/virt-customize.1.html), part of [libguestfs](http://libguestfs.org/) to run scripts that 'yum install' directly to the qcow2. Other utilities from this toolset are also used to grow/shrink/sparsify/manipulate the image(s).
* The undercloud qcow is generated by starting with the overcloud and adding/removing a few packages.
* The overcloud image is then written --> undercloud image, so when undercloud.qcow2 is booted by [tripleo-quickstart](https://github.com/openstack/tripleo-quickstart/), the overcloud image is present and ready to be deployed.

Role Variables
--------------

The defaults for image building are located at defaults/main.yml. With no params specified this role will build images for:

* Mitaka (RDO, delorean, current-passed-ci)
* http://trunk.rdoproject.org/centos7-mitaka/{{ artib_delorean_hash | default('current-passed-ci')}}/delorean.repo
* CentOS 7 base image
* Disk Image Builder (DIB) tools from liberty are used
* images are built in $virthost:/home/oooq-images

To change or customize how images are built and what they contain, enabling scenarios such as:

* {rdo, rhos} x {centos, rhel}
* RPM's, container (future), built from source (future)
* additional test tools or configuration (be vocal, submit issues/blueprints!)

Variable                          | Description
--------                          | -----------
artib_minimal_base_image_url      | base image for undercloud and overcloud
artib_repo_script                 | Jinja2 template bash script used to install repositories on base image for binaries via virt-customize
artib_dib_prepare_script          | Jinja2 template bash script used to prepare host for building images with DIB
artib_working_dir                 | All artifacts are created here.
artib_release                     | (rdo only): mitaka, liberty
artib_dib_elements_path           | defines ELEMENTS_PATH when calling disk-image-create
artib_dib_workarounds             | enabled (true) by default, this causes an additional virt-customize pass specifically to massage DIB inputs for temporary workarouds
artib_dib_workaround_script       | ^ the script for this
artib_dib_remove_epel             | if true, removes epel from the DIB elements tree with hostility
artib_dib_release_rpm             | where DIB itself comes from. Default: "http://rdoproject.org/repos/openstack-liberty/rdo-release-liberty.rpm"
artib_dib_environment_additional  | dict() with key-value (NAME=value) settings for DIB (e.g. DIB_YUM_REPO_CONF). These are added to the env just prior to running disk-image-create
artib_undercloud_remove_packages  | the undercloud image is generated by starting with the overcloud, removing packages from, and adding packages to it. This is the list of packages to remove
artib_undercloud_install_packages | ^ this is the list of packages to add
artib_overcloud_package_list      | the set of packages installed (by yum) on the images. Default: vars/default_package_list.yml
artib_overcloud_images            | the list of artifacts that are packaged and published by invoking this role

### Here are the full defaults contained in defaults/main.yml. Note that most are internal and should not be modified.

```YAML
artib_working_dir: /var/lib/oooq-images

# repo_setup vars
artib_minimal_base_image_url: http://cloud.centos.org/centos/7/images/CentOS-7-x86_64-GenericCloud.qcow2
artib_minimal_overwrite_existing: no
artib_base_os: centos7
artib_release: mitaka
artib_build_system: delorean
artib_repo_script: "repo-{{ artib_base_os }}-{{ artib_release }}-{{ artib_build_system }}.sh.j2"

# package_install vars
artib_overcloud_base_image_url: "file:///{{ artib_working_dir }}/minimal-base.qcow2"
artib_overcloud_overwrite_existing: no
artib_package_install_script: package-install-default.sh.j2
artib_overcloud_package_list: default_package_list.yml

# convert_undercloud vars
artib_undercloud_base_image_url: "file:///{{ artib_working_dir }}/overcloud-base.qcow2"
artib_undercloud_overwrite_existing: no
artib_undercloud_convert_script: undercloud-convert-default.sh.j2
artib_undercloud_disk_size: 40
artib_virt_customize_ram: 28000
artib_virt_customize_cpu: 4
artib_undercloud_remove_packages:
  - cloud-init
  - mariadb-galera-server
  - python-manila
artib_undercloud_install_packages:
  - mariadb-server
  - openstack-tempest
  # -tests packages which contains tempest-style tests
  - python-aodh-tests
  - python-ceilometer-tests
  - python-heat-tests
  - python-ironic-tests
  - python-neutron-tests
  - python-sahara-tests
artib_undercloud_selinux_permissive: true

# dib_build vars
artib_dib_workarounds:       true
artib_dib_workaround_script: dib-workaround-default.sh.j2
artib_dib_elements_path:     /usr/share/tripleo-image-elements:/usr/share/tripleo-puppet-elements:/usr/share/instack-undercloud/:/usr/share/openstack-heat-templates/software-config/elements/
artib_dib_prepare_script:    dib-prepare-centos7-default.sh.j2
artib_dib_remove_epel:       true
artib_dib_release_rpm:       "http://rdoproject.org/repos/openstack-liberty/rdo-release-liberty.rpm"

# undercloud_inject vars
artib_overcloud_images:
  - ironic-python-agent.initramfs
  - ironic-python-agent.kernel
  - overcloud-full.initrd
  - overcloud-full.qcow2
  - overcloud-full.vmlinuz

# fail, ignore, continue. See http://libguestfs.org/virt-sparsify.1.html
artib_virt_sparsify_checktmpdir_flag: fail
```

Dependencies
------------

No other galaxy roles are leveraged. libvirt and portions of KVM are used to build images.

Consumers of this role (known)
------------------------------

Anyone who wants to build images. Tools such as:
* [C.A.T.](https://github.com/redhat-openstack/ci-ansible-tripleo)
* [tripleo-quickstart](https://github.com/openstack/tripleo-quickstart)

Example Playbook
----------------

    - hosts: servers
      roles:
         - { role: ansible-role-tripleo-image-build }

# How to contribute

Contributions and patches are welcome!  Feel free to log issues and/or discuss here:

[https://github.com/redhat-openstack/ansible-role-tripleo-image-build/issues](https://github.com/redhat-openstack/ansible-role-tripleo-image-build/issues)

Code reviews and patches are managed by Gerrit here:

[https://review.gerrithub.io/#/q/project:redhat-openstack/ansible-role-tripleo-image-build](https://review.gerrithub.io/#/q/project:redhat-openstack/ansible-role-tripleo-image-build)

Ideas for substantive changes and/or features/targets/requirements, reach out on IRC at #rdo or please submit a blueprint here:

[https://github.com/redhat-openstack/ansible-role-tripleo-image-build/blueprints](https://github.com/redhat-openstack/ansible-role-tripleo-image-build/blueprints)

### How to: setup env --> propose a patch:

```bash
$ git clone ssh://github.com/redhat-openstack/ansible-role-tripleo-image-build
  ...
$ cd ansible-role-tripleo-image-build/
$ git review -s
Creating a git remote called "gerrit" that maps to:
	ssh://github-username@review.gerrithub.io:29418/redhat-openstack/ansible-role-tripleo-image-build.git

$ git remote -v
gerrit	ssh://github-username@review.gerrithub.io:29418/redhat-openstack/ansible-role-tripleo-image-build.git (fetch)
gerrit	ssh://github-username@review.gerrithub.io:29418/redhat-openstack/ansible-role-tripleo-image-build.git (push)
origin	ssh://github.com/redhat-openstack/ansible-role-tripleo-image-build (fetch)
origin	ssh://github.com/redhat-openstack/ansible-role-tripleo-image-build (push)
```
* create a branch (git checkout -b my-groovy-idea)
* add files and commit
* Post review (git review)

The commit message should be of the form:

```bash
A single line description of the change

A multi-line description of the change, ideally with
context and/or URL to github issue.
```

To address feedback and iterate on reviews, amend your existing commit (git commit --amend) and run "git review" again. Be sure to leave the Change-Id alone!

License
-------

Apache2

Author Information
------------------

redhat-openstack

